<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detoxify: AI Algorithm Harmonizer</title>
    
    <!-- Socket.IO Client CDN -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <!-- Futuristic Fonts: Orbitron for headers, Space Mono for content -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Color & Effect Variables (Futuristic Dark Theme) --- */
        :root {
            --color-primary-neon: #00e6e6; /* Bright cyan/teal */
            --color-primary-neon-dark: #00b3b3;
            --color-secondary-accent: #ff00ff; /* Magenta for secondary highlights */
            --color-text-light: #e0e0e0; 
            --color-text-dim: #a0a0a0;
            --color-bg-dark: #1a1a2e; /* Deep dark purple-blue */
            --color-bg-card: rgba(30, 30, 60, 0.6); /* Translucent dark card */
            --shadow-glow-primary: 0 0 15px rgba(0, 230, 230, 0.6), 0 0 30px rgba(0, 230, 230, 0.3);
            
            --radius-sharp: 8px;
            --font-main: 'Space Mono', monospace;
            --font-header: 'Orbitron', sans-serif;
        }

        /* --- Animations --- */
        @keyframes background-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes glow {
            0% { text-shadow: 0 0 5px var(--color-primary-neon); }
            50% { text-shadow: 0 0 15px var(--color-primary-neon), 0 0 25px rgba(0, 230, 230, 0.5); }
            100% { text-shadow: 0 0 5px var(--color-primary-neon); }
        }
        @keyframes slide-in {
            from { opacity: 0; transform: translateY(40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0px var(--color-primary-neon); }
            100% { box-shadow: 0 0 0 10px rgba(0, 230, 230, 0); }
        }

        /* --- Base & Layout --- */
        body { 
            font-family: var(--font-main); 
            margin: 0; 
            padding: 50px 20px; 
            background: linear-gradient(-45deg, #1a1a2e, #0e111a, #1a1a2e, #33334d); 
            background-size: 400% 400%;
            animation: background-flow 30s ease infinite; 
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            color: var(--color-text-light);
            overflow: hidden; 
        }
        .container { 
            max-width: 480px; 
            width: 100%;
            padding: 40px; 
            background-color: var(--color-bg-card); 
            border-radius: var(--radius-sharp); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid rgba(0, 230, 230, 0.2); 
            box-shadow: var(--shadow-glow-primary); 
            animation: slide-in 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards; 
            position: relative;
            z-index: 10;
        }

        /* --- Header --- */
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        .header h1 { 
            font-family: var(--font-header); 
            font-size: 2.5em; 
            font-weight: 700;
            color: var(--color-primary-neon); 
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px; 
            animation: glow 3s infinite alternate; 
        }
        .header h1 .emoji {
            font-size: 1.6em; 
            color: var(--color-secondary-accent); 
            filter: drop-shadow(0 0 5px var(--color-secondary-accent)); 
            transition: transform 0.3s ease;
        }
        .header:hover .emoji {
            transform: rotate(360deg) scale(1.1); 
        }
        .header p.subtitle {
            font-size: 1.0em;
            color: var(--color-text-dim);
            margin-top: 5px;
            font-weight: 400;
        }
        .input-group {
            margin-bottom: 25px;
        }

        /* --- Form Elements --- */
        label {
            font-weight: 700; 
            margin-bottom: 10px; 
            color: var(--color-text-light);
            display: block;
            font-size: 1.0em;
            text-shadow: 0 0 5px rgba(0, 230, 230, 0.3); 
        }
        input[type="text"], textarea { 
            padding: 14px 18px; 
            border: 1px solid rgba(0, 230, 230, 0.3); 
            border-radius: var(--radius-sharp); 
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            color: var(--color-text-light);
            background-color: rgba(0, 0, 0, 0.3); 
            box-shadow: inset 0 0 8px rgba(0, 230, 230, 0.1); 
            transition: all 0.3s ease;
            font-family: var(--font-main);
            resize: vertical;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: var(--color-primary-neon);
            box-shadow: inset 0 0 10px rgba(0, 230, 230, 0.5), 0 0 10px var(--color-primary-neon), 0 0 20px var(--color-primary-neon); 
            outline: none;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .disclaimer {
            font-size: 0.8em;
            color: #ff6347;
            margin-top: 5px;
            margin-bottom: 25px;
            text-shadow: 0 0 3px rgba(255, 99, 71, 0.5);
        }
        
        /* --- Button --- */
        button { 
            padding: 15px 20px; 
            background: var(--color-primary-neon); 
            color: var(--color-bg-dark); 
            border: none; 
            border-radius: var(--radius-sharp); 
            cursor: pointer; 
            font-size: 17px;
            font-weight: 700; 
            width: 100%;
            box-sizing: border-box;
            box-shadow: var(--shadow-glow-primary); 
            transition: all 0.3s ease;
            letter-spacing: 1px; 
        }
        button:hover:not(:disabled) { 
            background: var(--color-primary-neon-dark); 
            box-shadow: 0 0 25px var(--color-primary-neon), 0 0 50px rgba(0, 230, 230, 0.7); 
            transform: scale(1.02); 
        }
        button:active:not(:disabled) {
            transform: scale(0.98); 
            box-shadow: 0 0 10px var(--color-primary-neon);
            background-color: var(--color-primary-neon);
        }
        button:disabled {
            background: #4a4a66;
            color: #8888aa;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Status Area --- */
        h2 {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--color-secondary-accent); 
            margin-top: 40px; 
            margin-bottom: 10px;
            text-shadow: 0 0 5px rgba(255, 0, 255, 0.5); 
        }
        #status { 
            padding: 18px; 
            border-radius: var(--radius-sharp); 
            white-space: pre-wrap; 
            font-size: 0.9em; 
            font-family: var(--font-main);
            min-height: 90px; 
            line-height: 1.4;
            overflow-y: auto; 
            max-height: 250px;
            background-color: rgba(0, 0, 0, 0.2); 
            border: 1px solid rgba(255, 0, 255, 0.2); 
            box-shadow: inset 0 0 8px rgba(255, 0, 255, 0.1); 
            color: var(--color-text-light);
            transition: all 0.3s ease; 
        }
        
        /* --- Status Classes (Enhanced with Glows) --- */
        .status-ready { 
            background-color: rgba(0, 0, 0, 0.2); 
            color: var(--color-text-dim); 
            border-color: rgba(0, 230, 230, 0.1); 
            box-shadow: inset 0 0 5px rgba(0, 230, 230, 0.05);
        }
        .status-success { 
            background-color: rgba(0, 150, 0, 0.2); 
            color: #90ee90; 
            border-color: #00ff00; 
            box-shadow: 0 0 10px #00ff00, inset 0 0 5px #00ff00; 
        } 
        .status-in-progress { 
            background-color: rgba(255, 165, 0, 0.2); 
            color: #ffd700; 
            border-color: var(--color-primary-neon); 
            box-shadow: 0 0 15px var(--color-primary-neon); 
            animation: pulse-ring 1.5s infinite; 
        }
        .status-error { 
            background-color: rgba(150, 0, 0, 0.2); 
            color: #ff6347; 
            border-color: #ff0000; 
            box-shadow: 0 0 10px #ff0000, inset 0 0 5px #ff0000; 
        } 
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">ü§ñ</span> Detoxify</h1> 
            <p class="subtitle">AI Algorithm Harmonizer</p>
        </div>
        
        <div class="input-group">
            <label for="topicInput">1. Define Topic Focus:</label>
            <input type="text" id="topicInput" value="Rust programming" placeholder="e.g., Quantum Computing, Neural Networks">
        </div>

        <!-- NEW INPUT FOR COOKIES -->
        <div class="input-group">
            <label for="cookieInput">2. Paste YouTube Session Cookies (JSON Array):</label>
            <textarea id="cookieInput" rows="4" placeholder='[{"name": "SID", "value": "...", "domain": ".youtube.com", ...}]'></textarea>
            <p class="disclaimer">‚ö†Ô∏è **CRITICAL:** This data is highly sensitive and is required for login. It is NOT stored.</p>
        </div>
        <!-- END NEW INPUT -->

        <button id="detoxButton" disabled>INITIATE ALGORITHM DETOX</button>

        <h2>// Session Logs:</h2>
        <pre id="status" class="status-ready">Awaiting system input...</pre>
    </div>

    <script>
        // --- SOCKET.IO CLIENT SETUP ---
        // FIX: Changed 'localhost' to explicit IP '127.0.0.1' to bypass network/DNS issues
        const socket = io('http://127.0.0.1:3000', { 
            transports: ['websocket']
        }); 
        let currentStatusText = "";

        const log = (message, className = 'status-in-progress', append = true) => {
            const timestamp = `[${new Date().toLocaleTimeString()}] `;
            const statusBox = document.getElementById('status');
            
            if (append) {
                currentStatusText = timestamp + message + "\n" + currentStatusText;
            } else {
                currentStatusText = timestamp + message;
            }
            
            // Limit log lines
            const maxLines = 15;
            const lines = currentStatusText.split('\n');
            if (lines.length > maxLines) {
                currentStatusText = lines.slice(0, maxLines).join('\n') + "\n[...logs truncated]";
            }

            statusBox.textContent = currentStatusText;
            statusBox.className = className;
        };

        const detoxButton = document.getElementById('detoxButton');

        // Initialize status on load
        log("System Initializing...", 'status-in-progress', false);
        
        // Listen for real-time messages from the backend
        socket.on('log', (data) => {
            log(data.message, data.type || 'status-in-progress', true);
        });

        // Listen for final completion status
        socket.on('detoxComplete', (data) => {
             log(`DETOX COMPLETE. ${data.message}`, 'status-success', true);
             detoxButton.disabled = false; // Re-enable button
        });

        // Listen for critical errors
        socket.on('detoxError', (data) => {
            log(`CRITICAL FAILURE: ${data.message}`, 'status-error', true);
            detoxButton.disabled = false; // Re-enable button
        });
        
        // --- CONNECTION LOCK LOGIC (FIX for HTTP 400) ---
        socket.on('connect', () => {
             log(`Connection established (ID: ${socket.id}). Awaiting command.`, 'status-ready', false);
             detoxButton.disabled = false; // ENABLE button on confirmed connection
        });
        
        socket.on('disconnect', () => {
             log("LOST CONNECTION: Backend server disconnected. Please restart Node.js.", 'status-error', false);
             detoxButton.disabled = true;
        });
        
        // --- FORM SUBMISSION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const topicInput = document.getElementById('topicInput');
            const cookieInput = document.getElementById('cookieInput');
            
            // Set initial button state to disabled until socket connects
            if (!socket.connected) {
                detoxButton.disabled = true; 
            }

            // ‚ö†Ô∏è IMPORTANT: Ensure your backend runs on this port! ‚ö†Ô∏è
            // Changed from localhost to 127.0.0.1
            const BACKEND_URL = 'http://127.0.0.1:3000/detox/start'; 

            detoxButton.addEventListener('click', async () => {
                // Clear previous logs and reset status
                currentStatusText = "";
                log("Session initializing...", 'status-in-progress', false);

                const topic = topicInput.value.trim();
                const rawCookies = cookieInput.value.trim(); 
                
                // Final validation checks (though button should be locked if socket is down)
                if (!topic || !rawCookies || !socket.id) {
                    log('CRITICAL ERROR: Please ensure a topic is set, cookies are pasted, and the backend connection is active.', 'status-error', true);
                    detoxButton.disabled = false;
                    return;
                }

                detoxButton.disabled = true; // Disable immediately on click
                log(`PROCESS STARTED for topic "${topic}". Sending request to backend...`, 'status-in-progress', true);

                try {
                    const DURATION_SECONDS = 60; 

                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            topic: topic, 
                            duration: DURATION_SECONDS,
                            userCookies: rawCookies,
                            socketId: socket.id // Pass the unique socket ID for targeted messaging
                        }), 
                    });

                    // The HTTP response should be quick (200 OK); full status comes over WebSocket
                    if (!response.ok) {
                        const data = await response.json();
                        // This handles the 400 error immediately if the data was bad
                        log(`HTTP FAILURE (Status ${response.status}): ${data.message || 'Server did not acknowledge request.'}`, 'status-error', true);
                        detoxButton.disabled = false; // Re-enable if HTTP fails instantly
                    }
                    
                } catch (error) {
                    log(`CONNECTION FAILED: Unable to reach backend service at ${BACKEND_URL}.`, 'status-error', true);
                    detoxButton.disabled = false;
                } 
            });
        });
    </script>
</body>
</html>
